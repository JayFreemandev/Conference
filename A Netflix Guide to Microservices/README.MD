# 넷플릭스의 마이크로서비스

15년전 장모님이 응급실에 실려갔는데 이미 몸이 마비가 된 상태였다. Guliain? 무슨 특수한 면역 질환이였고  
외부 요인에 의해 신경 세포가 스스로 망가지는 병이였다. 여러 요법들을 시도했고 운이 좋게도 성공했다.  
  
다시 그 병에 걸리지 않으려고 건강하게 먹고 운동도 더 하고 그렇게 살고있는데 세상에는 별 일이 다 생기고        
나쁜 박테리아 등등 많은 일이 생긴다. 이런 세상에서 사람이 숨쉬는 행동만해도 세상과 상호작용도 하고 정말 기적같고 용감한 행동이다.                   
  
마이크로서비스 설명하러와서 왜 이런소리하냐?       
이런 세상에서 용감하게 숨쉬는 행동들이 마이크로서비스 아키텍처에서 트래픽을 가져오는것이다.    

![image](https://user-images.githubusercontent.com/72185011/173217775-4b253e63-2291-4d80-85dc-b4bf518aa69b.png)

트래픽이 폭증할수도있고 디도스 공격을 받을수도있고 시스템이 전체적으로 다운되서 고객들이 서비스 이용을 못할수도있다.            
오늘의 주제인 마이크로 서비스 아키텍처는 좋은점도 있고 힘든점도 있다.                 
넷플릭스에서 7년동안 여러 종류의 실패에서 짱구를 굴리며 발견한 문제와 솔루션에 대해 이야기 할거다.    

마이크로 서비스에 대한 추상적인 설명에 앞서 마이크로 서비스가 아닌거에 대해 먼저 이야기하고싶다.  

![image](https://user-images.githubusercontent.com/72185011/173218034-d41af445-183b-4568-b0b9-f1ca7977197a.png) 

2000년대 초반에는 단순한 인프라 구조를 가지고있었다.  
자바 기반의 모놀리틱 코드 방식의 아키텍쳐는 하나의 코드 베이스를 주마다 배포하는데 문제는 뭐 변경하다가 에러날경우에    
날밤을 새워가며 문제점 찾아야했다. 코드 다시 빼보고 다시 돌려보고 하나에 어플리케이션에 코드를 다 집어넣어놨기 때문이다.   

모놀리식으로 사용된 데이터베이스 경우에는 더 심각했다. 오라클죽으면 서버 전체 다운된다.       
휴가마다 더 큰 하드웨어 찾으러다녔다 수직 확장시켜서 스케일업을 해야되기 때문이다.                   
엔지니어링 관점에서보면 매우 고통스럽다. 너무 타이트하게 서로 상호작용하기때문에 문제가 생길시 빠르게 대처할수없었다.        

위와 같은 구조의 예시들이 90년대하고 2000년대 초반에는 일반적인 패턴이였지만   
위와 같은 이유로 오늘날 서비스 구축을 저렇게 하지 않는 이유이다.  

그럼 마이크로 서비스는 뭔가?  

![image](https://user-images.githubusercontent.com/72185011/173218542-4987a64c-7ff9-4f97-919a-67e6aea518f1.png)

각각 자체 프로세스에서 실행하고 가벼운 방법으로 접근하는 소규모 서비스들의 모음으로 단일 애플리케이션을 개발하는 접근 방식이다.   
마틴 파울러가 설명한 마이크로서비스의 정의지만 다소 추상적이다.  
기술적으로는 틀린말이 하나 없는데 2% 부족하다.   
   
마이크로 서비스를 구축한다는게 무엇을 의미하는지에 대해 설명이 부족한거같아서 내가 2000년대 겪었던 경험을 좀 덧대보자면 관심사분리다.   
워크로드를 분산시키고 수평적으로 확장할수있는 확장성(Scalability), 가상화와 자동화다.

![image](https://user-images.githubusercontent.com/72185011/173218732-5d6e8b2a-1be1-40aa-bc3e-330dd7aa14b3.png)

아까 숨쉬는거 마저 이야기하자면 이 모든 장기들은 각자 할일을 하고  이 할일들이 모여 전체적인 조화를이룬다. 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/811a1874-581e-432f-8e35-2436fe9a110c/Untitled.png)

영상에서보면 선들하고 저 딱콩들에서 무언가가 실시간으로 움직임

ELB뒤에 동적 라우팅을 담당하는 Zuul이라는 프록시 레이어가 있다.

앞에는 NCCP라고하는 레거시 티어가 있는데 이전 장비를 호환시켜주고 기본적인 동영상 재생을 시켜준다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f3f89052-daed-4f51-968a-19f1267f4e11/Untitled.png)

넷플릭스 API는 API 게이트웨이를 통해 호출되는데 이게 오늘날 모던 아키텍쳐의 핵심이다. 외부 고객들의 모든 요청을 받기 위해 다른 서비스들을 호출한다. 해당 계층을 엣지 서비스라고 한다.  

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e5d513b5-8fdf-4065-8cc6-03b970bb802d/Untitled.png)

오른족으로 갈수록 미드티어와 플랫폼 단계이다. 구독 서비스, 추천 서비스, 라우팅 서비스, 암호화 서비스, 데이터 보존 서비스등 어플리케이션의 오브젝트들처럼 전체 생태계의 일부처럼 동작한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/08fc646d-afa0-45bf-a299-cc901978a649/Untitled.png)

마이크로 서비스는 추상적이다. 우리는 단순하게 이해하려는 경향이 있는데 수평적으로 잘 확장되니 별 문제 없이 접근하겠지.

그렇게 간단하지가 않다. 언젠가 데이터를 영구 저장할 DB가 필요할거다. 어떤 시점에는 캐시가 필요하게 될거다. 

서비스와 DB가 빠릿빠릿 대응못할수도 있어서 클라이언트에서 사용할 캐시들도 필요하다. 캐시에 먼저 접근해서 실패하면 서비스로가고 DB 응답 다시 반환하고 다시 부를때 반환값들을 다시 캐시에 넣어서 다음번에는 눈깜짝할사이에 콜할수있게될거다.

클라이언트 관점에서 살펴보면 이 전체적인 기술들과 설정의 조합이 마이크로 서비스고 ‘무상태(Stateless)같이 이론적으로 간단한게 아니라 복잡하다. 실제로는 이 구조를 감싸고있는 복잡한 설계를 이해해야한다.

그래서 이제 넷플릭스가 봉착했던 문제들과 해결한 방법 그리고 철학에 대해서 이야기해보려고한다.
